<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 
Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">  
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Tokyo Jogging</title>
    <style>
    <!--
    	
    	*{ 
    		margin:0; padding:0;
    	}
    	div#street{ 
    		width: 100%; height: 800px;
    	}
    	div#distance{
    		position:absolute;right:0px; top:0px;
    	}
    	div#distance span{
    		color:#FFF; font-weight:bold;
    	}
    	span#distance-value{
    		font-size:10em;
    	}
    	span#distance-unit{
    		font-size:2em;
    	}
    	div#map{
    		width:300px; height: 250px; position:absolute; left:0px; top:0; 
    	}
    	div#navi{
    		position:absolute; left:40%; top:300px; 
    	}
    	div#navi a{
    		display : block;
    		width : 377px;
    		height : 155px;
    		background : url(./btn_start_jogging.png) no-repeat;
    	}
    	div#navi a:link,div#navi a:visited{
    		background-position : 0 0;
    	}
    	div#navi a:hover{
    		background-position : 0 -155px;
    	}
    	div#navi a span{
    		display : none;
    	}
    	v\:* {behavior:url(#default#VML);}

    -->
    </style>
    <script src="http://lab.katsuma.tv/js/jquery.js" type="text/javascript"></script>
	<script src="./wiimote_status.js" type="text/javascript"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAN2rU_LDe3rJrWbi3yPhjyBTGWVD4AirXn3LOL6bWbXjLdIwEeRSe7zsCxB-nAqzU2oXxHHazrTux3A"
      type="text/javascript"></script>
  </head>
	
	
  <body>
	
	<div id="street"></div>
	<div id="distance">
		<span id="distance-value">0</span>
		<span id="distance-unit">km</span>
	</div>
	<div id="navi"><a href="javascript:void(0);"><span>Start Jogging</span></a></div>
	<div id="map"></div>

    <script type="text/javascript">

    //<![CDATA[
    
    var TJ = {
		panorama : {},
		currentYaw : 0,
		currentPitch : 0,
		currentZoom : 0,
		zoomingIn : true,
		balanceBoardStatus : {},
		position : {},//shibuya,
		
		firstJog : true,
		currentPoint : null,
		prevPoint : null,
		distanceHistory : 0,
		
		map : null,
		marker : null,
		mapZoomLevel : 17
		
    };
    
    
    WiimoteStatus.actions = {
    	jog : function(){
    		TJ.panorama.followLink(TJ.currentYaw);
    	},
    	    
    	stop : function(){
    		TJ.panorama.followLink(TJ.currentYaw+180);
    	},	
    	
    	left : function(){
    		TJ.currentYaw -= 15;
      		TJ.panorama.panTo({yaw:TJ.currentYaw, pitch:TJ.currentPitch, zoom:TJ.currentZoom});
 		},
    	
    	right : function(){
   			TJ.currentYaw += 15;
   			TJ.panorama.panTo({yaw:TJ.currentYaw, pitch:TJ.currentPitch, zoom:TJ.currentZoom});
    	}
   };
    
    
//	$(function(){
	
		var mapElement = document.getElementById("map");	
		TJ.position = new GLatLng(35.660990,139.701376/*35.658517, 139.745493*/);
		
		// init map
		TJ.map = new GMap2(mapElement);
		TJ.map.setCenter(TJ.position, TJ.mapZoomLevel);

		var guyIcon = new GIcon(G_DEFAULT_ICON);
		guyIcon.image = "http://maps.google.com/intl/en_us/mapfiles/cb/man_arrow-0.png";
//		guyIcon.image = "http://tokyo-jogging.com/images/marker-katsuma.png";
		guyIcon.transparent = "http://maps.google.com/intl/en_us/mapfiles/cb/man-pick.png";
		guyIcon.imageMap = [
			26,13, 30,14, 32,28, 27,28, 28,36, 18,35, 18,27, 16,26,
			16,20, 16,14, 19,13, 22,8
		];
		guyIcon.iconSize = new GSize(49, 52);
		guyIcon.iconAnchor = new GPoint(25, 35);
		//guyIcon.infoWindowAnchor = new GPoint(5, 0);

		TJ.marker = new GMarker(TJ.position, {icon:guyIcon, draggable:false});
		TJ.map.addOverlay(TJ.marker);
		GEvent.addListener(TJ.marker, "click", function(){
			TJ.marker.openInfoWindowHtml("<img src=\"http://tokyo-jogging.com/images/marker-katsuma.png\" /><p>katsuma</p>");
		});
		
		TJ.currentPoint = TJ.prevPoint = TJ.marker.getPoint();
		
		// init panorama
		TJ.panorama = new GStreetviewPanorama(document.getElementById("street"));
		TJ.panorama.setLocationAndPOV(
			TJ.position, 
			{ yaw:TJ.currentYaw, pitch: TJ.currentPitch, zoom: TJ.currentZoom}
		);
		
		// add event listener
		GEvent.addListener(TJ.panorama, "initialized", function(loc){
			var _TJ = window.TJ;
			_TJ.map.panTo(loc.latlng);
			_TJ.marker.setLatLng(loc.latlng);
			
			_TJ.prevPoint = _TJ.currentPoint;
			_TJ.currentPoint = _TJ.marker.getPoint(); 
			_TJ.distanceHistory += _TJ.currentPoint.distanceFrom(_TJ.prevPoint) /1000;
			if(!_TJ.firstJog) {
				$("#distance-value").html(_TJ.distanceHistory.toFixed(2));
				var line = new GPolyline([_TJ.prevPoint, _TJ.currentPoint]);
				_TJ.map.addOverlay(line);
			}
			_TJ.firstJog = false;
		});	

		// move marler to start position
		var gsClient = new GStreetviewClient();
		gsClient.getNearestPanorama(TJ.position, function(data){
			if(data.code!=200) return;
			var newPoint = data.location.latlng;
			var _TJ = window.TJ;
			_TJ.map.panTo(newPoint);
			_TJ.marker.setLatLng(newPoint);
		});
		
		// start connecting to wiimote manager
		//WiimoteStatus.initialize();
		
		$('#navi a').click(function(){
			$('#navi a').hide();	
			WiimoteStatus.initialize();
		});

	// test
      $(window).keypress(function(e){
      	switch(e.which){
      		case 106: // j
      			WiimoteStatus.actions.jog();
      			break;
      		case 107: // k
      			WiimoteStatus.actions.jog();
      			break;
      		case 104: // h
      			WiimoteStatus.actions.left();
       			break;
      		case 108: // l
      			WiimoteStatus.actions.right();
       			break;
      		default:     		
      	}
      });

//	});
	$('body').unload(GUnload);
		
    //]]>
    </script>


  </body>
</html>